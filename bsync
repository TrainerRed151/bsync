#!/bin/bash

# don't accept bsync commands unless repo is already initialized
if [ ! -d ".bsync/" ] && [ "$1" != "init" ]; then
    echo "Not a bsync repository"
    exit 1
fi

case $1 in
    # initialize repo
    init)
    # don't re-init repo
    if [ -d ".bsync/" ]; then
        echo "Already initialized bsync repository"
    
    # create config file and place name on first line
    else
        mkdir .bsync
        cd .bsync
        touch config
        echo $2 >> config
        echo "Initialized bsync repository `head -n 1 config` in `pwd`"
    fi
    ;;

    remote)
    case $2 in
        add)
        cd .bsync
        if grep -q "=$3" config; then
            echo "$3 already saved as `grep "=$3" config | cut -d '=' -f 1`"
        else
            # test if remote repo exists
            RHOST=`echo $3 | cut -d ':' -f 1`
            RPATH=`echo $3 | cut -d ':' -f 2`
            if RNAME=`ssh -q $RHOST head -n 1 "$RPATH/.bsync/config" 2>/dev/null`; then
                echo "$RNAME=$3" >> config
                echo "$RNAME->$3"
            else
                echo "No bsync repository at $3"
            fi
        fi
        ;;
    esac
    ;;
            
esac

# Copyright Â© 2016 Brian Pomerantz. All Rights Reserved.
